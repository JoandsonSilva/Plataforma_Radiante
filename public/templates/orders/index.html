<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos - Radiante Perfumaria</title>
    <link rel="stylesheet" href="../../static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <img src="../../static/img/logo.png" alt="Plataforma Radiante">
            </div>
            <nav>
                <ul>
                    <li><a href="http://127.0.0.1:5500/Plataforma_Radiante/public/templates/dashboard/index.html"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li><a href="../products/index.html"><i class="fas fa-box"></i> Produtos</a></li>
                    <li><a href="../resellers/index.html"><i class="fas fa-users"></i> Revendedores</a></li>
                    <li><a href="../orders/index.html" class="active"><i class="fas fa-shopping-cart"></i> Pedidos</a></li>
                    <li><a href="../sales_tracking/index.html"><i class="fas fa-chart-line"></i> Controle de Vendas</a></li>
                    <li><a href="../cash_control/index.html"><i class="fas fa-cash-register"></i> Controle de Caixa</a></li>
                    <li><a href="../tasks/index.html"><i class="fas fa-tasks"></i> Tarefas</a></li>
                    <li><a href="../settings/index.html"><i class="fas fa-cog"></i> Configurações</a></li>
                </ul>
            </nav>
        </div>

        <div class="main-content">
            <header>
                <div class="header-content">
                    <h1>Pedidos</h1>
                    <div class="user-info">
                        <span id="userEmail"></span>
                        <button id="logoutBtn" class="btn-logout">Sair</button>
                    </div>
                </div>
            </header>

            <div class="content">
                <!-- Filtros -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="status">Status</label>
                                    <select class="form-control" id="status">
                                        <option value="">Todos</option>
                                        <option value="pending">Pendente</option>
                                        <option value="approved">Aprovado</option>
                                        <option value="delivered">Entregue</option>
                                        <option value="cancelled">Cancelado</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="dateStart">Data Inicial</label>
                                    <input type="date" class="form-control" id="dateStart">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="dateEnd">Data Final</label>
                                    <input type="date" class="form-control" id="dateEnd">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="reseller">Revendedor</label>
                                    <select class="form-control" id="reseller">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button class="btn btn-primary" id="filterBtn">
                                    <i class="fas fa-filter"></i> Filtrar
                                </button>
                                <button class="btn btn-secondary" id="clearFilterBtn">
                                    <i class="fas fa-times"></i> Limpar Filtros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de Pedidos -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Revendedor</th>
                                        <th>Produtos</th>
                                        <th>Valor Total</th>
                                        <th>Status</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <!-- Pedidos serão inseridos aqui via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB3b8HR1Gcmfp4YMh7Ibj7a-X7sGYd_6uk",
            authDomain: "plataforma-radiante.firebaseapp.com",
            projectId: "plataforma-radiante",
            storageBucket: "plataforma-radiante.appspot.com",
            messagingSenderId: "990096383941",
            appId: "1:990096383941:web:46541971f9a5e86ead75ac",
            measurementId: "G-VZZZYRQZFP"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Verificar autenticação
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('userEmail').textContent = user.email;
                loadOrders();
                loadResellers();
            } else {
                window.location.href = '../../index.html';
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await auth.signOut();
                window.location.href = '../../index.html';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
                alert('Erro ao fazer logout. Por favor, tente novamente.');
            }
        });

        // Carregar revendedores
        async function loadResellers() {
            try {
                const resellersSnapshot = await db.collection('resellers').get();
                const resellerSelect = document.getElementById('reseller');
                
                resellersSnapshot.forEach(doc => {
                    const reseller = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = reseller.name;
                    resellerSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar revendedores:', error);
            }
        }

        // Carregar pedidos
        async function loadOrders(filters = {}) {
            try {
                let query = db.collection('orders');

                if (filters.status) {
                    query = query.where('status', '==', filters.status);
                }
                if (filters.resellerId) {
                    query = query.where('resellerId', '==', filters.resellerId);
                }
                if (filters.dateStart) {
                    query = query.where('createdAt', '>=', new Date(filters.dateStart));
                }
                if (filters.dateEnd) {
                    const endDate = new Date(filters.dateEnd);
                    endDate.setHours(23, 59, 59, 999);
                    query = query.where('createdAt', '<=', endDate);
                }

                const ordersSnapshot = await query.orderBy('createdAt', 'desc').get();
                const ordersTableBody = document.getElementById('ordersTableBody');
                ordersTableBody.innerHTML = '';

                if (ordersSnapshot.empty) {
                    ordersTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center">Nenhum pedido encontrado</td>
                        </tr>
                    `;
                    return;
                }

                ordersSnapshot.forEach(doc => {
                    const order = doc.data();
                    const row = document.createElement('tr');
                    
                    // Formatar lista de produtos
                    const productsList = order.products ? order.products.map(p => 
                        `${p.name} (${p.quantity}x)`
                    ).join('<br>') : 'N/A';

                    row.innerHTML = `
                        <td>${doc.id}</td>
                        <td>${order.resellerName || 'N/A'}</td>
                        <td>${productsList}</td>
                        <td>R$ ${order.total.toFixed(2)}</td>
                        <td>
                            <span class="badge ${getStatusBadgeClass(order.status)}">
                                ${getStatusText(order.status)}
                            </span>
                        </td>
                        <td>${formatDate(order.createdAt)}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewOrder('${doc.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="editOrder('${doc.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    `;
                    
                    ordersTableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Erro ao carregar pedidos:', error);
                alert('Erro ao carregar pedidos. Por favor, tente novamente.');
            }
        }

        // Funções auxiliares
        function getStatusBadgeClass(status) {
            const classes = {
                'pending': 'badge-warning',
                'approved': 'badge-info',
                'delivered': 'badge-success',
                'cancelled': 'badge-danger'
            };
            return classes[status] || 'badge-secondary';
        }

        function getStatusText(status) {
            const texts = {
                'pending': 'Pendente',
                'approved': 'Aprovado',
                'delivered': 'Entregue',
                'cancelled': 'Cancelado'
            };
            return texts[status] || status;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('pt-BR');
        }

        // Funções de ação
        function viewOrder(orderId) {
            window.location.href = `show.html?id=${orderId}`;
        }

        function editOrder(orderId) {
            window.location.href = `edit.html?id=${orderId}`;
        }

        // Eventos de filtro
        document.getElementById('filterBtn').addEventListener('click', () => {
            const filters = {
                status: document.getElementById('status').value,
                resellerId: document.getElementById('reseller').value,
                dateStart: document.getElementById('dateStart').value,
                dateEnd: document.getElementById('dateEnd').value
            };
            loadOrders(filters);
        });

        document.getElementById('clearFilterBtn').addEventListener('click', () => {
            document.getElementById('status').value = '';
            document.getElementById('reseller').value = '';
            document.getElementById('dateStart').value = '';
            document.getElementById('dateEnd').value = '';
            loadOrders();
        });
    </script>
</body>
</html> 